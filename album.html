<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mckaziwe Media</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/sidebars/">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- <link href="assets/sidebars.css" rel="stylesheet">-->
  
</head>

<body>
  <div class="modal fade" id="photoInfoDisplay" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">New message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="recipient-name" class="col-form-label">Date:</label>
              <input type="text" disabled class="form-control" id="date">
              <input type="hidden" id="id">
            </div>
            <div class="mb-3">
              <label for="message-text" class="col-form-label">Description:</label>
              <textarea class="form-control" id="description-text"></textarea>
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input id="pin-image" name="pin-image" type="checkbox" value="pin" class="form-check-input" autocomplete="off">
                <label class="form-check-label" for="pin-image"><strong>Pin this image</strong> 
                <p><small><em>Pinned images will show on the landing page</em> </small> </p>
            
            </label>
                
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="delete">Delete</button>
          <button type="button" class="btn btn-primary" id="update">Update</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Upload Image</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="recipient-name" class="col-form-label">Image:</label>
              <input type="file" class="form-control" id="photo" required="">
            </div>
            <div class="mb-3">
              <label for="description" class="col-form-label">Description(<em>optional</em>):</label>
              <textarea class="form-control" id="description"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="upload-photo">Upload</button>
        </div>
      </div>
    </div>
  </div>
  <div class="p-3 px-4 side-bar bg-dark" style="width: 18rem;">
    <a href="/" class="d-flex align-items-center pb-3 mb-3 link-white text-decoration-none">
      <div class="bi pe-none side-nav-menu"></div>
    </a>
    <ul class="list-unstyled ps-0 side-bar-menu">
      <li class="mb-1 nav-item">
        <a href="#" class="d-inline-flex align-items-center border-0 active"  aria-expanded="true">
          Home
        </a>
      </li>
      <li class="mb-1">
        <a href="#" id="collapsible" class="btn-toggle d-inline-flex align-items-center border-0 collapsed" data-bs-toggle="collapse" data-bs-target="#dashboard-collapse" aria-expanded="false">
          Gallery
        </a>
        <div class="collapse" id="dashboard-collapse">
            <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small sub-items">
            <li><a href="#" class="d-inline-flex mb-1 text-decoration-none ">- Creative Design</a></li>
            <li><a href="#" class="d-inline-flex mb-1 text-decoration-none ">- Brand & Identity</a></li>
            <li><a href="#" class="d-inline-flex mb-1 text-decoration-none ">- Company Profile</a></li>
            <li><a href="#" class="d-inline-flex mb-1 text-decoration-none ">- Booklets</a></li>
            <li><a href="#" class="d-inline-flex mb-1 text-decoration-none ">- Photography</a></li>
            <li><a href="#" class="d-inline-flex mb-1 text-decoration-none ">- Videography</a></li>
            <li><a href="#" class="d-inline-flex mb-1 text-decoration-none ">- Mockups</a></li>
          </ul>
        </div>
      </li>
      <li class="mb-1 nav-item">
        <a href="#" class=" d-inline-flex align-items-center border-0"  aria-expanded="true">
          About
        </a>
      </li>
    </ul>
  </div>
  <main>
    <div class="quote-container pt-5 text-white">
      <h1>Photography</h1>

      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">Upload photo</button>
    </div>

    <div class="album pt-3" id="photo-list">
      <ul class="list-group list-group-flush mt-3" id="album-list">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </ul>


    </div>



    <div class="toast align-items-center bg-success text-white position-absolute p-1 m-3 bottom-0 end-0" role="alert"
      id="toast" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toast-body"></div>
        <button id="close-toast" type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>


  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
  <script src="assets/js/jquery.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>

  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>


  <script>
    $(document).ready(function () {
      const firebaseConfig = {

        apiKey: "AIzaSyB-tEIY3LlVKA-bjslG_bJ2Yk3zb2YphG0",

        authDomain: "unza-connect.firebaseapp.com",

        projectId: "unza-connect",

        storageBucket: "unza-connect.appspot.com",

        messagingSenderId: "768834600387",

        appId: "1:768834600387:web:f248e6d61cec0202505176"

      };

      const app = firebase.initializeApp(firebaseConfig);
      const storage = firebase.storage().ref();

      const db = firebase.firestore();

      var downloadUrl;

      // creates a new photo album  to Cloud Firestore.
      $("#close-toast").on("click", function () {
        $("#toast").hide();
      })

      // get  photo albums
      // getPhotoAlbums();
      getPhotos();
      function getPhotos() {
        // loading...
        $("#photo-list").html(" ");
        db.collection("mckaziwe-photo-albums").doc(extractUrl()).collection("photos").get().then((querySnapshot) => {
          $("#album-list").html("");
          querySnapshot.forEach((doc) => {
            // doc.data() is never undefined for query doc snapshots
            $("#photo-list").append(`
                <div style="cursor: pointer;" class="album-item" data-bs-toggle="modal" data-bs-target="#photoInfoDisplay" data-bs-id="${doc.id}" data-bs-date="${doc.data().date.toDate().toDateString()}" data-bs-description="${doc.data().description}" data-bs-pin-image="${doc.data().pined}" data-bs-download-url="${doc.data().fileName}">
                  <img width="100%" src="${doc.data().fileName}" alt="${doc.data().description}">
              </div>
            `);
          });
        });
      }


      // extract id from url
      function extractUrl() {
        var url = document.URL;
        var id = url.substring(url.lastIndexOf('=') + 1);
        return id;

      }
      
      $("#upload-photo").on("click", function(event){
        event.preventDefault();
        uploadPhoto();
      })

      // uplaods photos
      function uploadPhoto() {
        $("#upload-photo").attr("disabled", true);
        let file = $('#photo').get(0).files[0];
        let name = (+new Date()) + '-' + file.name;
        // Create the file metadata
        var metadata = {
          contentType: file.type 
        };

        // Upload file and metadata to the object 'images/mountains.jpg'
        var uploadTask = storage.child('mckaziwe-photos/' + name).put(file, metadata);

        // Listen for state changes, errors, and completion of the upload.
        uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
          (snapshot) => {
            // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
            var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log('Upload is ' + progress + '% done');
            $("#upload-photo").html("Uploading: " + parseInt(progress, 10) + "%");
            switch (snapshot.state) {
              case firebase.storage.TaskState.PAUSED: // or 'paused'
                console.log('Upload is paused');
                break;
              case firebase.storage.TaskState.RUNNING: // or 'running'
                console.log('Upload is running');
                break;
            }
          },
          (error) => {
            $("#upload-photo").attr("disabled", false);
            $("#upload-photo").html("Upload +");
            // A full list of error codes is available at
            // https://firebase.google.com/docs/storage/web/handle-errors
            switch (error.code) {
              case 'storage/unauthorized':
                // User doesn't have permission to access the object
                console.log("User doesn't have permission to access the object");
                break;
              case 'storage/canceled':
                // User canceled the upload
                console.log("User canceled the upload");
                break;

              // ...

              case 'storage/unknown':
                // Unknown error occurred, inspect error.serverResponse
                console.log("Unknown error occurred, inspect error.serverResponse");
                break;
            }
          },
          () => {
            // Upload completed successfully, now we can get the download URL
            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
              console.log('File available at', downloadURL);
              console.log("Done");
              // put file in database
              let documentId = Date.now().toString(36) + Math.random().toString(36).substr(2);
              console.log(documentId);
              db.collection("mckaziwe-photo-albums").doc(extractUrl()).collection("photos").doc(documentId).set({
                fileName: downloadURL,
                description: $("#description").val(),
                pined: false,
                date: firebase.firestore.FieldValue.serverTimestamp()
              }).then(() => {
                // show photos un categorized
                // db.collection("mckaziwe-photos").doc(documentId).set({
                //   fileName: downloadURL,
                //   description: $("#description").val(),
                //   date: firebase.firestore.FieldValue.serverTimestamp()
                // }).then(()=>{
                  // console.log(data);
                  uploadModal.hide();

                $("#toast-body").html(`Photo added successfully 😊`);
                $("#toast").show();
                getPhotos();
                $("#upload-photo").attr("disabled", false);
                $("#upload-photo").html("Upload +");
                // })
                

              }).catch((error) => {
                console.log(error.message)
              })
            });
          }
        );
      }

      //  Vavriable content 
      var photoInfoDisplay = document.getElementById('photoInfoDisplay')
      var photoInfoDisplayModal = new bootstrap.Modal(document.getElementById('photoInfoDisplay'), {
        keyboard: false
      })
      var uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'), {
        keyboard: false
      })

      photoInfoDisplay.addEventListener('show.bs.modal', function (event) {
        // Button that triggered the modal
        var button = event.relatedTarget
        // Extract info from data-bs-* attributes
        var date = button.getAttribute('data-bs-date')
        var description = button.getAttribute('data-bs-description')
        var id = button.getAttribute('data-bs-id')
        var pinImage = button.getAttribute('data-bs-pin-image')
        downloadUrl = button.getAttribute('data-bs-download-url')
        document.getElementById('pin-image').setAttribute('checked', 'checked');
        // If necessary, you could initiate an AJAX request here
        // and then do the updating in a callback.
        //
        // Update the modal's content.
        if (pinImage == "false") {
          // uncheck
          document.getElementById('pin-image').removeAttribute('checked');
          console.log("Attribute removed")
        } else{
            //Check
            document.getElementById('pin-image').setAttribute('checked', 'checked');
            console.log("Attr added");
        }

        photoInfoDisplay.querySelector('.modal-title').textContent = "Edit Image"
        photoInfoDisplay.querySelector('.modal-body #description-text').value = description
        photoInfoDisplay.querySelector('.modal-body #date').value = date
        photoInfoDisplay.querySelector('.modal-body #id').value = id
        
      
      })

        $("#update").on("click", function(e){
          $(this).attr("disabled", true);
          $("#delete").attr("disabled", true);
          e.preventDefault();
          // do stuff
          let id = photoInfoDisplay.querySelector('.modal-body #id').value;
          console.log($("#description-text").val());

          db.collection("mckaziwe-photo-albums").doc(extractUrl()).collection("photos").doc(id).update({
                description: $("#description-text").val(),
                pined: document.getElementById("pin-image").checked
              }).then(() => {
                // show photos un categorized
                if(!document.getElementById("pin-image").checked){

                  db.collection("mckaziwe-photos").doc(id).delete().then(()=>{
                    console.log(id);
                  photoInfoDisplayModal.hide();

                  $("#toast-body").html(`Image details updated successfully`);
                  $("#toast").show();
                  getPhotos();
                  $("#update").attr("disabled", false);
                  $("#delete").attr("disabled", false);
                  })
                } else{
                  db.collection("mckaziwe-photos").doc(id).set({
                    fileName: downloadUrl,
                    description: $("#description").val(),
                    date: firebase.firestore.FieldValue.serverTimestamp()
                  
                }).then(()=>{
                  console.log(id);
                  photoInfoDisplayModal.hide();

                  $("#toast-body").html(`Image details updated successfully`);
                  $("#toast").show();
                  getPhotos();
                  $("#update").attr("disabled", false);
                  $("#delete").attr("disabled", false);

                })
                }
              
               
              }).catch((error) => {
                console.log(error)
              })
          
        });
        $("#delete").on("click", function(e){
          e.preventDefault();
          // do stuff
          let id = photoInfoDisplay.querySelector('.modal-body #id').value;
          db.collection("mckaziwe-photo-albums").doc(extractUrl()).collection("photos").doc(id).delete().then((message) => {
                // show photos un categorized
                db.collection("mckaziwe-photos").doc(id).delete().then(()=>{
                  photoInfoDisplayModal.hide();

                  $("#toast-body").html(`Photo removed successfully`);
                  $("#toast").show();
                  getPhotos();
                  $("#update").attr("disabled", false);
                  $("#delete").attr("disabled", false);

                })
               
              }).catch((error) => {
                console.log(error.message)
              })
        });
    });





  </script>
</body>

</html>